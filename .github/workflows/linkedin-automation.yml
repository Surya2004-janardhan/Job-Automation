name: LinkedIn Outreach Automation

on:
  schedule:
    # Runs once daily at 10:00 AM UTC (3:30 PM IST)
    - cron: "0 10 * * *"

  workflow_dispatch: # Allow manual triggering
    inputs:
      limit:
        description: "Max messages to send (max 25/day)"
        required: false
        default: "20"

jobs:
  linkedin-outreach:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Node.js (for email notifications)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      - name: Install Python dependencies
        run: |
          pip install selenium pandas openpyxl

      - name: Install Node dependencies
        run: npm install nodemailer

      - name: Run LinkedIn Outreach
        id: linkedin
        run: |
          cd inb
          python linkedin_outreach.py \
            --cookie "${{ secrets.LINKEDIN_COOKIE }}" \
            --excel "linkedin-data.xlsx" \
            --limit ${{ github.event.inputs.limit || '20' }} \
            --headless 2>&1 | tee linkedin_output.txt
        env:
          LINKEDIN_COOKIE: ${{ secrets.LINKEDIN_COOKIE }}
        continue-on-error: true

      - name: Commit updated files
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add inb/linkedin-data.xlsx
          [ -f inb/linkedin_quota.json ] && git add inb/linkedin_quota.json || echo "No quota file to add"
          git commit -m "Update LinkedIn status - $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Send SUCCESS notification email
        if: steps.linkedin.outcome == 'success'
        run: |
          node -e "
          const nodemailer = require('nodemailer');
          const fs = require('fs');

          const output = fs.existsSync('inb/linkedin_output.txt') 
            ? fs.readFileSync('inb/linkedin_output.txt', 'utf8').slice(-3000) 
            : 'No output captured';

          const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
          });

          transporter.sendMail({
            from: process.env.EMAIL_USER,
            to: 'chintalajanardhan2004@gmail.com',
            subject: '✅ LinkedIn Outreach - Success',
            html: \`
              <h2>LinkedIn Outreach Completed</h2>
              <p>Date: \${new Date().toISOString()}</p>
              <pre style='background:#f4f4f4;padding:10px;'>\${output}</pre>
            \`
          }).then(() => console.log('Notification sent'));
          "
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

      - name: Send FAILURE notification email
        if: steps.linkedin.outcome == 'failure'
        run: |
          node -e "
          const nodemailer = require('nodemailer');
          const fs = require('fs');

          const output = fs.existsSync('inb/linkedin_output.txt') 
            ? fs.readFileSync('inb/linkedin_output.txt', 'utf8').slice(-3000) 
            : 'No output captured';

          const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS }
          });

          transporter.sendMail({
            from: process.env.EMAIL_USER,
            to: 'chintalajanardhan2004@gmail.com',
            subject: '❌ LinkedIn Outreach - FAILED',
            html: \`
              <h2>LinkedIn Outreach Failed</h2>
              <p>Date: \${new Date().toISOString()}</p>
              <p>Please check the workflow logs.</p>
              <pre style='background:#f4f4f4;padding:10px;'>\${output}</pre>
            \`
          }).then(() => console.log('Notification sent'));
          "
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

      - name: Fail the workflow if LinkedIn step failed
        if: steps.linkedin.outcome == 'failure'
        run: exit 1
